<html>
 <head>
     <title>Proyecto final - WebGL</title>  
 </head>
 <body>
    <h1 style="text-align: center;">Final Project</h1>
    <div id="container" style="width:95%; height:90%; position:absolute"></div>
    <script type="module">
        import * as THREE from './build/three.module.js';

        import { GLTFLoader } from './loaders/GLTFLoader.js';

        var renderer = null,
        scene = null,
        camera = null,
        rootNode = null,
        animating = false;

        const mixers = [];
        const clock = new THREE.Clock();
        var cloudsArr = [];

        init();
    
        function init() {
            // x: left - right
            // y: up - down
            // z: front - back
            var container = document.getElementById("container");
    
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);
    
            scene = new THREE.Scene();
            scene.background = new THREE.Color( 0x8fbfff );

            camera = new THREE.PerspectiveCamera( 45, container.offsetWidth / container.offsetHeight,
                    1, 4000);
            camera.position.set(0, 9, 14);
            camera.rotation.x = -Math.PI / 5;
            
            rootNode = new THREE.Object3D();

            var light = new THREE.DirectionalLight(0xffffff, 2.5);
            light.castShadow = true;
            light.position.set(5, 5, 3);
            rootNode.add(light);

            /*
            var mapURL = "./tex_img.jpg";
            map = THREE.ImageUtils.loadTexture(mapURL);
            var material = new THREE.MeshPhongMaterial({map: map});
            */

            loadMultipleModels(rootNode, 'Sheep.glb', 0.1, [[1,2], [2,2], [-1, 3]]);
            //loadMultipleModelsWithAnimation(rootNode, 'SheepWalking.glb', 0.1, [[1,1], [2,2], [-1, 3]]);
            // Pigs eating from Haystacks
            loadMultipleModelsWithAnimation(rootNode, 'PigEating.glb', 0.1, [[-1,0.2, -3], [-1.5,0.2, -3.3], [1, 0.2, -3.1]]);
            loadMultipleModels(rootNode, 'Tree.glb', 0.2,
                [[6,6], [-5,-4], [-6, 7.5],
                [6,-6], [5,4], [-8, 5.5],[7, 0],
                [-5, 0.5], [-7, -2], [8, -1]]);
            loadMultipleModels(rootNode, 'Tree3.glb', 0.2,
                [[-7.5,-5.5], [4.5,-3.5], [3, 5.5],
                [5,8], [7,-7], [8, 7.5], [-7, 3], [-2, -8],
                [0, -6], [2, -7]]);
            loadCloudModels(rootNode, 'cloud.glb', 0.2, [[-5.5,-4.5], [6.5,-2.5], [1, 5], [-10, 3.5], [-10, -12],
                                                        [2, -9], [3, -9], [-6.5,-4.0], [5, -14], [-16, 0], [-18, -4]]);
            
           /*  loader.load( 'Wolf.glb', function ( gltf ) {
                let sheepNode = new THREE.Object3D();
                sheepNode.add(gltf.scene);
                sheepNode.scale.set(0.1, 0.1, 0.1);
                sheepNode.position.set(2,0.5,0);
                rootNode.add(sheepNode);
            } ); */

            var grassMaterial = new THREE.MeshPhongMaterial({color:0x009911});
            var grassGeometry = new THREE.CubeGeometry(20, 0.1, 20);
            var grass = new THREE.Mesh(grassGeometry, grassMaterial);
            grass.position.set(0, 0, 0)
            rootNode.add(grass);

            
            var fenceOne  = drawFence(-1.2,0.3,-1.8);
            fenceOne.rotation.y = -1.6;
            for(let i = 0.1; i < 4.2; i += 0.5) {
                drawFence(2.8,0.3,i);
            }

            for(let i = -2; i < 3; i += 0.5) {
                var fence = drawFence(4,0.3,i);
                fence.rotation.y = -1.6;
            }

            for(let i = 0.0; i < 4.2; i += 0.5) {
                drawFence(-2.8,0.3,i);
            }

            var fenceTwo = drawFence(-1,0.3,2.8);
            fenceTwo.rotation.y = -1.6;
           
        
            var barnMaterial = new THREE.MeshPhongMaterial({color:0xaa0000});
            var barnGeometry = new THREE.CubeGeometry(4, 1, 2);
            var barn = new THREE.Mesh(barnGeometry, barnMaterial);
            barn.position.set(0, 0.5, -2)
            rootNode.add(barn)

            var haystackMaterial = new THREE.MeshPhongMaterial({color:0x998800});
            var haystackGeometry = new THREE.CubeGeometry(0.5, 0.25, 0.3);
            addPrimitiveModels(rootNode, haystackGeometry, haystackMaterial,
                [[1, 0.125, -0.5], [1.5, 0.125, -0.5], [1.25, 0.25, -0.5],
                [-1, 0.125, -0.5], [-1.5, 0.125, -0.5], [-1.25, 0.25, -0.5]]);

            var sphereMaterial = new THREE.MeshBasicMaterial( {color: 0xffff00} );
            var sphereGeo = new THREE.SphereGeometry(0.4, 32, 32);
            var sun = new THREE.Mesh(sphereGeo, sphereMaterial);
            sun.position.set(5, 5, 3)
            rootNode.add(sun);
            
            scene.add(rootNode);
    
            addMouseHandler();
    
            run();
        }

        function loadModel(modelName) {
            const loader = new GLTFLoader().setPath( 'models/' );
            let modelNode = new THREE.Object3D();

            loader.load( modelName, function ( gltf ) {
                let model = gltf.scene;
                modelNode.add(model);
            } );

            return modelNode;
        }

        function loadModelWithAnimation(modelName) {
            const loader = new GLTFLoader().setPath( 'models/' );
            let modelNode = new THREE.Object3D();

            loader.load( modelName, function ( gltf ) {
                let model = gltf.scene;
                modelNode.add(model);
                let model_mixer = new THREE.AnimationMixer( model );
				model_mixer.clipAction( gltf.animations[ 0 ] ).play();
                mixers.push(model_mixer)
                animate();
            } );

            return modelNode;
        }

        function loadMultipleModels(rootNode, modelName, scale, positions) {
            for (let i = 0; i < positions.length; i++) {
                let modelNode = loadModel(modelName);
                modelNode.scale.set(scale, scale, scale);
                modelNode.position.set(positions[i][0],0,positions[i][1]);
                rootNode.add(modelNode);
            }
        }

        function loadMultipleModelsWithAnimation(rootNode, modelName, scale, transforms) {
            // transform [ x, z, rotation ]
            for (let i = 0; i < transforms.length; i++) {
                let modelNode = loadModelWithAnimation(modelName);
                modelNode.scale.set(scale, scale, scale);
                modelNode.rotation.y = transforms[i][2];
                modelNode.position.set(transforms[i][0],0,transforms[i][1]);
                rootNode.add(modelNode);
            }
        }

        function addPrimitiveModels(rootNode, geo, mat, positions) {
            for (let i = 0; i < positions.length; i++) {
                let mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(positions[i][0],positions[i][1],positions[i][2]);
                rootNode.add(mesh);
            }
        }

        function loadCloudModels(rootNode, modelName, scale, positions) {
            for (let i = 0; i < positions.length; i++) {
                let modelNode = loadModel(modelName);
                modelNode.scale.set(scale, scale, scale);
                modelNode.position.set(positions[i][0],2,positions[i][1]);
                modelNode.rotation.y = -1.6;
                modelNode.rotation.x = 1.6;
                cloudsArr.push(modelNode);
                rootNode.add(modelNode);
            }
        }
        
        function run() {
            renderer.render(scene, camera);
            if (animating) {
                //rootNode.rotation.y -= 0.01
                // Move clouds
                for (var i = 0; i < cloudsArr.length; i++){
                    moveCloud(cloudsArr[i]);
                }
            }
    
            requestAnimationFrame(run);
        }
    
        function addMouseHandler() {
            var dom = renderer.domElement;
            dom.addEventListener('mouseup', onMouseUp, false);
        }
    
        function onMouseUp(event) {
            event.preventDefault();
            animating = !animating;
        }

        // Move cloud in x axis
        function moveCloud(cloudModel) {
            let minX = -18
            let maxX = 18
            let moveSpeed = 0.01;

            let pos = new THREE.Vector3();
            cloudModel.getWorldPosition(pos);
            let new_pos = pos.x + moveSpeed;
            if (new_pos > maxX){
                new_pos = minX
            }
            cloudModel.position.set(new_pos, pos.y, pos.z);
        }

        function animate() {
            requestAnimationFrame( animate );
            const delta = clock.getDelta();
            if (animating) {
                for (let i = 0; i < mixers.length; i++) {
                    mixers[i].update( delta );
                }
            }
        }

        function drawFence(x,y,z) {
            let group = new THREE.Group();
            let verticalOneGeo = new THREE.CubeGeometry(0.1,0.5,0.1);
            let verticalTwoGeo = new THREE.CubeGeometry(0.1,0.5,0.1);
            let horizontalOneGeo = new THREE.CubeGeometry(0.1,0.1,1);
            let horizontalTwoGeo = new THREE.CubeGeometry(0.1,0.1,1);

            var bMat = new THREE.MeshPhongMaterial({color:0xE1C6A9});

            let verticalOne = new THREE.Mesh(verticalOneGeo,bMat);
            let verticalTwo = new THREE.Mesh(verticalTwoGeo,bMat);
            let horizontalOne = new THREE.Mesh(horizontalOneGeo,bMat);
            let horizontalTwo = new THREE.Mesh(horizontalTwoGeo,bMat);

            group.add(verticalOne);
            group.add(horizontalOne);
            group.add(horizontalTwo);
            group.add(verticalTwo);

            verticalOne.position.set(x, y, z);
            verticalTwo.position.set(x, y, z-1);
            horizontalOne.position.set(x, y-0.1, z-0.5);
            horizontalTwo.position.set(x, y+.1, z-0.5);
            
            rootNode.add(group);
            return group;
        }
    
      </script>
 </body>
</html>